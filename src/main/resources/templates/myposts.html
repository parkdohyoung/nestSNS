<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>내 게시글</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #FFFFFF; /* 수정된 색상 */
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* 경계 효과 */
      border-radius: 10px; /* 둥근 모서리 */
    }

    .comment-box-container {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px; /* 내부 여백 추가 */
      background-color: #f9f9f9; /* 밝은 배경 */
    }

    .comment-box {
      flex: 1;
      border: none;
      resize: none;
      outline: none;
      padding: 10px;
      font-size: 14px;
    }

    .comment-submit {
      position: absolute;
      right: 10px;
      bottom: 10px;
      padding: 5px 15px;
      font-size: 14px;
      color: white;
      background-color: #007bff; /* 버튼 색상 */
      border: none;
      border-radius: 5px;
      white-space: nowrap; /* 텍스트 줄바꿈 방지 */
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .comment-submit:hover {
      background-color: #0056b3; /* 호버 상태 색상 */
    }
  </style>


</head>
<body>
<div class="container mt-5">
  <h1 class="text-center mb-4">내 게시글</h1>

  <!-- 버튼: 개인정보 수정 -->
  <div class="d-flex justify-content-end mb-4">
    <a href="/posts/edit/new" class="btn btn-primary me-2">게시글 등록</a>
    <a href="/account/edit" class="btn btn-warning">개인정보 수정</a>
  </div>


  <!-- 게시글 목록 -->
  <div th:if="${posts != null and posts.content.size() > 0}" class="row">
    <div id="post-[[${post.id}]]" th:each="post : ${posts.content}" class="mb-4">

      <!-- 게시글 내용 -->
      <div class="card">
        <small class="text-muted mse-2 ">
          <div class="d-flex align-items-center">
            <img th:src="@{/uploads/{filename}(filename=${post.account.profileImgPath != null ? post.account.profileImgPath : 'default-profile.png'})}"
                 class="rounded-circle m-2 p-auto"
                 alt="작성자 프로필 이미지"
                 style="width: 30px; height: 30px; object-fit: cover;">
            <p class="mb-0 flex-grow-1" th:text="${post.account.name}">작성자</p>
            <small class="text-muted d-block me-2 " style="margin-left: auto" th:text="${post.createDate != null ? #temporals.format(post.createDate, 'yyyy-MM-dd HH:mm:ss') : '작성일 정보 없음'}"></small>
          </div>

          <small class="d-flex justify-content-end">
            <a th:href="@{/posts/edit/{id}(id=${post.id})}" class="btn btn-outline-secondary btn-sm me-2">수정</a>
            <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="post" class="d-inline">
              <button type="submit" class="btn btn-danger btn-sm me-2">삭제</button>
            </form>
          </small>
        </small>

        <img class="m-2" th:if="${post.imagePath != null}" th:src="@{'/uploads/' + ${post.imagePath}}" alt="게시글 이미지">

        <div class="card-body">
          <p class="card-text" th:text="${post.message}">게시글 내용</p>

          <ul id="comment-list-[[${post.id}]]" class="list-group">
            <!-- 최상위 댓글 렌더링 -->
            <li class="list-group-item" th:each="comment : ${post.comments}" th:if="${comment.parentComment == null}">
              <div class="d-flex align-items-center">
                <img th:src="@{/uploads/{filename}(filename=${comment.account.profileImgPath != null ? comment.account.profileImgPath : 'default-profile.png'})}"
                     class="rounded-circle me-2"
                     style="width: 30px; height: 30px; object-fit: cover;">
                <p class="mb-0 flex-grow-1" th:text="${comment.account.name}">댓글 작성자</p>
                <small class="text-muted"
                       th:text="${comment.createDate != null ? #temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm:ss') : '작성일 정보 없음'}"></small>
              </div>
              <p th:text="${comment.commentMessage}">댓글 내용</p>
              <button class="btn btn-link btn-sm" onclick="setParentCommentId([[${comment.id}]], '[[${comment.account.name}]]')">댓글 작성</button>


              <!-- 대댓글 재귀 렌더링 -->
              <ul th:if="${comment.replies != null}" class="list-group mt-3 reply">
                <div th:each="reply : ${comment.replies}">
                  <li class="list-group-item">
                    <!-- 자식 댓글 재귀 호출 -->
                    <div th:replace="::comment-template(comment=${reply})"></div>
                  </li>
                </div>
              </ul>
            </li>

            <!-- 댓글 등록 폼 -->
            <div class="mt-3">
              <form th:action="@{/comments/new}" method="post" id="commentForm">
                <input type="hidden" name="parentId" id="parentId" value="">
                <input type="hidden" name="postId" th:value="${post.id}">
                <div class="comment-box-container">
                  <textarea class="form-control" name="commentMessage" rows="2" placeholder="댓글을 작성하세요" required></textarea>
                  <button type="submit" class="comment-submit">등록</button>
                </div>
              </form>
            </div>
          </ul>
        </div>
    </div>
  </div>
</div>

<!-- 게시글이 없는 경우 -->
<div th:if="${posts == null or posts.content.size() == 0}" class="text-center mt-5">
  <p class="text-muted">표시할 게시글이 없습니다.</p>
</div>
</div>

<!-- 댓글 프래그먼트 정의 -->
<div th:fragment="comment-template">
  <div class="d-flex align-items-center">
    <img th:src="@{/uploads/{filename}(filename=${comment.account.profileImgPath != null ? comment.account.profileImgPath : 'default-profile.png'})}"
         class="rounded-circle me-2"
         style="width: 30px; height: 30px; object-fit: cover;">
    <p class="mb-0 flex-grow-1" th:text="${comment.account.name}">댓글 작성자</p>
    <small class="text-muted"
           th:text="${comment.createDate != null ? #temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm:ss') : '작성일 정보 없음'}"></small>
  </div>
  <p th:text="${comment.commentMessage}">댓글 내용</p>
  <button class="btn btn-link btn-sm" onclick="setParentCommentId([[${comment.id}]], '[[${comment.account.name}]]')">댓글 작성</button>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
